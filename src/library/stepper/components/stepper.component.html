<!-- Step Headers -->
<div class="lib-stepper__header">
  @for (step of steps(); track trackByStep($index, step); let i = $index; let last = $last) {
    <div
      class="lib-stepper__step"
      [class.lib-stepper__step--active]="stepperService.activeIndex() === i"
      [class.lib-stepper__step--completed]="isStepCompleted(i)"
      [class.lib-stepper__step--error]="getStepError(i)"
      [class.lib-stepper__step--disabled]="isStepDisabled(i)"
      [class.lib-stepper__step--unreachable]="!isStepReachable(i)"
      [class.lib-stepper__step--optional]="step.optional()"
      [style.--step-index]="i"
    >
      <!-- Step Header Button -->
      <button
        type="button"
        class="lib-stepper__step-header"
        [attr.role]="'tab'"
        [attr.aria-selected]="stepperService.activeIndex() === i"
        [attr.aria-disabled]="!isStepReachable(i)"
        [attr.aria-controls]="'panel-' + step.internalId"
        [attr.tabindex]="stepperService.activeIndex() === i ? 0 : -1"
        [disabled]="!isStepReachable(i)"
        (click)="onStepHeaderClick(step, i)"
      >

        <!-- Step Icon/Number -->
        <div class="lib-stepper__step-icon">
          @if (step.iconTemplate(); as iconTmpl) {
            <ng-container *ngTemplateOutlet="iconTmpl"></ng-container>
          } @else if (isStepCompleted(i) && !getStepError(i)) {
            <svg class="lib-stepper__check-icon" viewBox="0 0 24 24" aria-hidden="true">
              <polyline points="20 6 9 17 4 12" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          } @else if (getStepError(i)) {
            <svg class="lib-stepper__error-icon" viewBox="0 0 24 24" aria-hidden="true">
              <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
              <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            </svg>
          } @else if (step.icon()) {
            <span class="lib-stepper__custom-icon">{{ step.icon() }}</span>
          } @else {
            <span class="lib-stepper__step-number">{{ i + 1 }}</span>
          }
        </div>

        <!-- Step Label -->
        <div class="lib-stepper__step-label">
          @if (step.labelTemplate(); as labelTmpl) {
            <ng-container *ngTemplateOutlet="labelTmpl"></ng-container>
          } @else {
            <span class="lib-stepper__step-label-text">{{ step.label() }}</span>
            @if (step.sublabel()) {
              <span class="lib-stepper__step-sublabel">{{ step.sublabel() }}</span>
            }
            @if (step.optional()) {
              <span class="lib-stepper__step-optional">Optional</span>
            }
            @if (getStepError(i); as errorMsg) {
              <span class="lib-stepper__step-error">{{ errorMsg }}</span>
            }
          }
        </div>
      </button>

      <!-- Connector (not on last step) -->
      @if (!last && showConnector()) {
        <div 
          class="lib-stepper__connector"
          [class.lib-stepper__connector--completed]="isStepCompleted(i)"
        ></div>
      }
    </div>
  }
</div>

<!-- Step Content Panel -->
<div 
  class="lib-stepper__content"
  [class]="animationClass()"
  [attr.id]="'panel-' + activeStep()?.internalId"
  [attr.role]="'tabpanel'"
  [attr.aria-labelledby]="activeStep()?.internalId"
  (animationend)="onAnimationEnd()"
>
  @if (activeStep(); as active) {
    <ng-container *ngTemplateOutlet="active.contentTemplate()"></ng-container>
  }
</div>
